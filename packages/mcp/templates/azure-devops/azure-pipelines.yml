trigger: none

schedules:
  - cron: "0 * * * *"
    displayName: "Hourly agent run"
    branches:
      include: [main]
    always: true

pool:
  vmImage: "ubuntu-latest"

variables:
  - group: bctb-secrets

steps:
  - checkout: self
    persistCredentials: true

  - task: NodeTool@0
    inputs:
      versionSpec: "20.x"

  - script: npm install -g bc-telemetry-buddy-mcp
    displayName: "Install BCTB MCP"

  - script: bctb-mcp agent run-all --once
    displayName: "Run all agents"
    env:
      BCTB_AUTH_FLOW: client_credentials
      BCTB_TENANT_ID: $(BCTB_TENANT_ID)
      BCTB_CLIENT_ID: $(BCTB_CLIENT_ID)
      BCTB_CLIENT_SECRET: $(BCTB_CLIENT_SECRET)
      BCTB_APP_INSIGHTS_ID: $(BCTB_APP_INSIGHTS_ID)
      BCTB_KUSTO_CLUSTER_URL: $(BCTB_KUSTO_CLUSTER_URL)
      AZURE_OPENAI_ENDPOINT: $(AZURE_OPENAI_ENDPOINT)
      AZURE_OPENAI_KEY: $(AZURE_OPENAI_KEY)
      AZURE_OPENAI_DEPLOYMENT: gpt-4o
      TEAMS_WEBHOOK_URL: $(TEAMS_WEBHOOK_URL)
      SMTP_PASSWORD: $(SMTP_PASSWORD)
      GRAPH_CLIENT_SECRET: $(GRAPH_CLIENT_SECRET)
      DEVOPS_PAT: $(DEVOPS_PAT)

  - script: |
      git config user.name "bctb-agent"
      git config user.email "bctb-agent@noreply.github.com"
      git add agents/
      git diff --cached --quiet || git commit -m "agent: run $(date -u +%Y-%m-%dT%H:%M)Z"
      git push origin HEAD:main
    displayName: "Commit agent state"
